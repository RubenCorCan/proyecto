<div class="productos-bg">
  <h1 class="productos-title">Tus Productos</h1>
  <div *ngFor="let categoria of categorias$ | async">
    <h2>{{ categoria.nombre }}</h2>
    <div class="productos-grid">
      <div class="producto-card" *ngFor="let p of (productosPorCategoria$ | async)?.[categoria.id]">
        <img [src]="p.imagen" alt="img" *ngIf="p.imagen" />
        <div *ngIf="editandoId !== p.id">
          <h4>{{ p.nombre }}</h4>
          <p>{{ getPrecio(p.precio) }}</p>
          <h4>Descripción:</h4>
          <p>{{ p.descripcion }}</p>
          <h4>Ingredientes:</h4>
          <p *ngIf="p.ingredientes">{{ p.ingredientes.join(', ') }}</p>
          <p *ngIf="p.categoria">{{ p.categoria.nombre }}</p>
          <div class="botones-card">
            <button (click)="empezarEdicion(p)">Editar</button>
            <button (click)="borrarProducto(p)">Borrar</button>
          </div>
        </div>
        <div *ngIf="editandoId === p.id">
          <label style="color: var(--primary-red);" for="nombreEdicion">Nombre</label>
          <input id="nombreEdicion" [(ngModel)]="editandoProducto.nombre" placeholder="Nombre" />

          <label style="color: var(--primary-red);" for="precioEdicion">Precio</label>
          <input id="precioEdicion" [(ngModel)]="editandoProducto.precio" type="number" placeholder="Precio" />

          <label style="color: var(--primary-red);">Modo de Imagen</label>
          <label>
            <input type="radio" name="modoImagen" [(ngModel)]="modoImagen" [value]="'local'" />
            Subir archivo local
          </label>
          <label>
            <input type="radio" name="modoImagen" [(ngModel)]="modoImagen" [value]="'publica'" />
            Elegir imagen pública
          </label>

          <input
            *ngIf="modoImagen === 'local'"
            type="file"
            (change)="onArchivoSeleccionado($event)"
            accept="image/*"
          />

          <div *ngIf="modoImagen === 'publica'">
            <p>Imágenes públicas disponibles</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <img
                *ngFor="let img of imagenesPublicasUrls "
                [src]="img"
                [class.selected]="img === imagenPublicaSeleccionada "
                (click)="imagenPublicaSeleccionada  = img"
                style="width: 100px; height: 100px; cursor: pointer; border: 2px solid transparent;"
                [style.border-color]="img === imagenPublicaSeleccionada  ? 'blue' : 'transparent'"
              />
            </div>
            <div *ngIf="imagenPublicaSeleccionada " style="margin-top: 10px;">
              <p>Imagen seleccionada</p>
              <img [src]="imagenPublicaSeleccionada " alt="Imagen seleccionada" style="width:150px; height:auto;" />
            </div>
          </div>

          <label style="color: var(--primary-red);" for="ingredientesEdicion">Ingredientes (separados por coma)</label>
          <input id="ingredientesEdicion" [(ngModel)]="editandoProducto.ingredientes" placeholder="Ingredientes (separados por coma)" />

          <label style="color: var(--primary-red);" for="descripcionEdicion">Descripción</label>
          <input id="descripcionEdicion" [(ngModel)]="editandoProducto.descripcion" placeholder="Descripción" />

          <label style="color: var(--primary-red);" for="categoriaEdicion">Categoría</label>
          <select id="categoriaEdicion" [(ngModel)]="editandoProducto.categoriaId" required>
            <option value="" disabled>Selecciona categoría</option>
            <option *ngFor="let cat of categorias$ | async" [value]="cat.id">{{ cat.nombre }}</option>
          </select>

          <button (click)="guardarEdicion(p.id)">Guardar</button>
          <button (click)="cancelarEdicion()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <button
    (click)="mostrarFormNuevo = !mostrarFormNuevo"
    *ngIf="!mostrarFormNuevo"
    class="nuevo-producto-button"
  >
    Agregar Nuevo Producto
  </button>

  <div class="nuevo-producto-form" *ngIf="mostrarFormNuevo">
    <label style="color: var(--primary-red);" for="nombreNuevo">Nombre</label>
    <input id="nombreNuevo" [(ngModel)]="nuevo.nombre" placeholder="Nombre" />

    <label style="color: var(--primary-red);" for="precioNuevo">Precio</label>
    <input id="precioNuevo" [(ngModel)]="nuevo.precio" type="number" placeholder="Precio" />

    <label style="color: var(--primary-red);">Modo de Imagen</label>
    <label>
      <input type="radio" name="modoImagenNuevo" [(ngModel)]="modoImagenNuevo" [value]="'local'" />
      Subir archivo local
    </label>
    <label>
      <input type="radio" name="modoImagenNuevo" [(ngModel)]="modoImagenNuevo" [value]="'publica'" />
      Elegir imagen pública
    </label>

    <input
      *ngIf="modoImagenNuevo === 'local'"
      type="file"
      (change)="onArchivoSeleccionado($event)"
      accept="image/*"
    />

    <div *ngIf="modoImagenNuevo === 'publica'">
      <p>Imágenes públicas disponibles</p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <img
          *ngFor="let img of imagenesPublicasUrls"
          [src]="img"
          [class.selected]="img === imagenPublicaSeleccionadaNuevo"
          (click)="imagenPublicaSeleccionadaNuevo = img"
          style="width: 100px; height: 100px; cursor: pointer; border: 2px solid transparent;"
          [style.border-color]="img === imagenPublicaSeleccionadaNuevo ? 'blue' : 'transparent'"
        />
      </div>
      <div *ngIf="imagenPublicaSeleccionadaNuevo" style="margin-top: 10px;">
        <p>Imagen seleccionada</p>
        <img [src]="imagenPublicaSeleccionadaNuevo" alt="Imagen seleccionada" style="width:150px; height:auto;" />
      </div>
    </div>

    <label style="color: var(--primary-red);" for="ingredientesNuevo">Ingredientes (separados por coma)</label>
    <input id="ingredientesNuevo" [(ngModel)]="nuevo.ingredientes" placeholder="Ingredientes (separados por coma)" />

    <label style="color: var(--primary-red);" for="descripcionNuevo">Descripción</label>
    <input id="descripcionNuevo" [(ngModel)]="nuevo.descripcion" placeholder="Descripción" />

    <label style="color: var(--primary-red);" for="categoriaNuevo">Categoría</label>
    <select id="categoriaNuevo" [(ngModel)]="nuevo.categoria" required>
      <option value="" disabled>Selecciona categoría</option>
      <option *ngFor="let cat of categorias$ | async" [value]="cat.id">{{ cat.nombre }}</option>
    </select>

    <button (click)="agregarProducto()">Agregar</button>
    <button (click)="mostrarFormNuevo = false">Cancelar</button>
  </div>
</div>
